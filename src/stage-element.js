import * as css from "./css";

/**
 * Class representing the UI Element of the stage.
 * Each Stage has one.
 * @private
 */
export default class StageElement {
    /**
     * constructor - Creates a Stage Element.
     *
     * @param {object} options - the stage for which the element is created.
     * @param {object} stage - the stage created.
     */
    constructor(options, stage) {
        const el = document.createElement("div");

        /**
         * createDiv - creates a div at specified zIndex.
         *
         * @param {number} zIndex - desired place in "stack"
         * @return {object} - a stage wide/high DOM element.
         */
        function createDiv(zIndex) {
            const sel = document.createElement("div");

            sel.style.width = `${options.width}px`;
            sel.style.height = `${options.height}px`;
            sel.style.zIndex = zIndex;
            sel.style.position = "absolute";
            sel.style.touchAction = "manipulation";

            return sel;
        }

        /**
         * createCanvas - creates a canvas at specified zIndex.
         *
         * @param {number} zIndex - desired place in "stack"
         * @return {object} - a stage wide/high DOM element.
         */
        function createCanvas(zIndex) {
            const cel = document.createElement("canvas");

            cel.width = options.width;
            cel.height = options.height;
            cel.style.zIndex = zIndex;
            cel.style.position = "absolute";
            cel.style.left = "0px";
            cel.style.top = "0px";

            return cel;
        }

        /**
         * createFlag - creates a "flag" div.
         *
         * @return {object} - a stage wide/high DOM element with flag at centers.
         */
        function createFlag() {
            const flagSize = 130;
            const fel = createDiv(-1);

            const felitem = document.createElement("div");

            // Convert the center based x coordinate to a left based one.
            const x = -(flagSize / 2);
            // Convert the center based y coordinate to a left based one.
            const y = -(flagSize / 2);

            // looks
            felitem.style.width = `${flagSize}px`;
            felitem.style.height = `${flagSize}px`;
            felitem.style.position = "absolute";
            felitem.innerHTML = "&#9873;";

            felitem.style.left = `${options.width / 2 + x}px`;
            felitem.style.top = `${options.height / 2 + y}px`;
            felitem.className = "blocklike-flag";

            fel.appendChild(felitem);
            fel.style.display = "none";

            return fel;
        }

        el.id = `${stage.id}`;

        el.style.width = `${options.width}px`;
        el.style.height = `${options.height}px`;

        el.style.position = "relative";
        el.style.boxSizing = "border-box";
        el.style.overflow = "hidden";

        options.parent.appendChild(el);

        this.backdropContainer = createCanvas(0);
        this.backdropContainer.id = `${stage.id}-backdrop`;
        this.backdropContainer.className = "blocklike-panel-backdrop";
        el.appendChild(this.backdropContainer);

        this.canvas = createCanvas(0);
        this.canvas.id = `${stage.id}-surface`;
        this.canvas.className = "blocklike-panel-surface";
        el.appendChild(this.canvas);

        this.flag = createFlag();
        this.flag.id = `${stage.id}-flag`;
        this.flag.className = "blocklike-panel-flag";
        el.appendChild(this.flag);

        this.context = this.canvas.getContext("2d");

        this.el = el;
    }

    /**
     * update - updates the DOM element.
     *
     * @param {import("./stage").default} stage - the stage to update.
     */
    update(stage) {
        const el = stage.element.el;
        const backdropContext =
            stage.element.backdropContainer.getContext("2d");

        let marginTB = 0;
        if (stage.element.el.parentElement.tagName === "BODY") {
            marginTB = Math.floor((innerHeight - stage.height) / 2);
            marginTB < 0 ? (marginTB = 0) : null;
        }

        // If color - fill the canvas with the color set, or clear it
        if (stage.backdrop && stage.backdrop.color) {
            backdropContext.rect(0, 0, stage.width, stage.height);
            backdropContext.fillStyle = stage.backdrop.color;
            backdropContext.fill();
        } else {
            backdropContext.clearRect(0, 0, stage.width, stage.height);
        }

        // If image - draw the image on canvas
        if (stage.backdrop && stage.backdrop.image) {
            const img = new Image();
            img.onload = () => {
                backdropContext.drawImage(img, 0, 0, stage.width, stage.height);
            };
            img.src = stage.backdrop.image;
        }

        el.style.filter = stage.getCSSFilter();
        // zoom and placement
        el.style.transform = `scale(${stage.magnification / 100})`;
        el.style.margin = `${marginTB}px auto`;

        // css rules
        css.apply(stage);

        // css classes
        stage.backdrop
            ? (el.className = stage.backdrop.classes
                  .concat(stage.classes)
                  .join(" "))
            : (el.className = stage.classes.join(" "));
    }

    /**
     * delete - deletes the DOM element
     */
    delete(stage) {
        const el = stage.element.el;

        el.parentNode.removeChild(el);
        return null;
    }

    /**
     * addFlag - puts the flag div infront of everything (shows it)
     *
     * @param {object} stage - the stage that "requested" the flag.
     */
    addFlag(stage) {
        const el = stage.element.flag;

        el.style.zIndex = 1000;
        el.style.display = "block";
    }

    /**
     * removeFlag - puts the flag div at the back (hides it)
     *
     * @param {object} stage - the stage that "requested" the flag.
     */
    removeFlag(stage) {
        const el = stage.element.flag;

        el.style.zIndex = -1;
        el.style.display = "none";
    }
}
